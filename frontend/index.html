<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manipur Issue Reporting Portal</title>

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;500;700&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet">

    <!-- Custom Design System -->
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <header>
        <div class="container header-content">
            <div class="branding">
                <img src="assets/logo.png" alt="Emblem">
                <div class="branding-text">
                    <h1>Manipur Issue Mapper</h1>
                    <p>Government of Manipur</p>
                </div>
            </div>

            <div class="nav-actions">
                <a href="live.html" class="btn btn-secondary">Live Heatmap</a>

                <div style="position: relative;">
                    <img src="https://api.dicebear.com/7.x/identicon/svg?seed=user" alt="Account" class="account-avatar"
                        id="accountLogo">
                    <div class="dropdown-menu" id="accountDropdown">
                        <button class="dropdown-item" onclick="showProfile()">My Profile</button>
                        <button class="dropdown-item" onclick="window.location.href='dashboard.html'">My
                            Reports</button>
                        <button class="dropdown-item danger" id="logoutBtn">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- PROFILE MODAL -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>My Profile</h3>
                <button class="close-modal" onclick="closeProfile()">√ó</button>
            </div>
            <div class="profile-info-row">
                <span class="profile-label">User ID</span>
                <span class="profile-value" id="profileUserId">#001</span>
            </div>
            <div class="profile-info-row">
                <span class="profile-label">Phone Number</span>
                <span class="profile-value">+91 98621 54321</span>
            </div>
            <div class="profile-info-row">
                <span class="profile-label">Role</span>
                <span class="profile-value">Citizen</span>
            </div>
            <div style="margin-top: 24px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeProfile()">Close</button>
            </div>
        </div>
    </div>

    <div class="split-layout">
        <!-- Sidebar Form -->
        <div class="sidebar-form">
            <h2 style="margin-bottom: 24px;">Report an Issue</h2>

            <form id="issueForm" autocomplete="off">
                <div class="form-group">
                    <label>Issue Title</label>
                    <input type="text" id="title" required placeholder="Brief title...">
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select id="category" required>
                        <option value="">Select category</option>
                        <option value="Road">Road & Transport</option>
                        <option value="Water">Water Supply</option>
                        <option value="Electricity">Electricity</option>
                        <option value="Sanitation">Sanitation</option>
                        <option value="Law">Law & Order</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Location</label>
                    <div class="flex-center gap-2">
                        <input type="text" id="location" readonly placeholder="Select on map" required>
                        <button type="button" id="detectLocationBtn" class="btn btn-secondary"
                            title="My Location">üìç</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" required placeholder="Describe details..."
                        style="height: 120px; resize: none;"></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">Submit Official
                    Report</button>

                <!-- Hidden -->
                <input type="hidden" id="lat"><input type="hidden" id="lng"><input type="hidden" id="aiCategory">
            </form>

            <div
                style="margin-top: auto; padding-top: 32px; font-size: 0.75rem; color: var(--text-muted); text-align: center;">
                Secure Government Portal ‚Ä¢ v2.0
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>



    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="utils.js"></script>

    <script>
        // ===== MAP INITIALIZATION =====
        // Base Layers
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        });

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO'
        });

        const map = L.map('map', {
            center: [24.8170, 93.9368],
            zoom: 12,
            layers: [streetLayer] // Default
        });

        // Layer Control
        const baseMaps = {
            "Street View": streetLayer,
            "Satellite": satelliteLayer,
            "Dark Mode": darkLayer
        };
        L.control.layers(baseMaps).addTo(map);

        let marker = null;

        // ===== MAP CLICK EVENT =====
        map.on('click', function (e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            // If marker exists, move it
            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng).addTo(map);
            }

            // Check for nearby issues
            fetch(`http://127.0.0.1:8000/api/issues/nearby?lat=${lat}&lng=${lng}&radius=0.5`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success' && data.count > 0) {
                        marker.bindPopup(`<b>${data.count} issues reported nearby!</b><br>Most recent: ${data.data[0].title}`).openPopup();
                    } else {
                        marker.bindPopup("Location selected.").openPopup();
                    }
                })
                .catch(err => console.error(err));

            document.getElementById('lat').value = lat;
            document.getElementById('lng').value = lng;
            if (window.showToast) showToast("Location selected", "info");
            reverseGeocode(lat, lng);
        });

        // ===== GEOLOCATION BUTTON =====
        document.getElementById('detectLocationBtn').onclick = function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (pos) {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;

                    map.setView([lat, lng], 15);
                    if (marker) map.removeLayer(marker);
                    marker = L.marker([lat, lng]).addTo(map)
                        .bindPopup('You are here').openPopup();

                    document.getElementById('lat').value = lat.toFixed(6);
                    document.getElementById('lng').value = lng.toFixed(6);
                    reverseGeocode(lat, lng);
                }, function () { alert('Enable location to use this feature.'); });
            } else {
                alert('Geolocation not supported.');
            }
        };

        // ===== REVERSE GEOCODE =====
        function reverseGeocode(lat, lng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(res => res.json())
                .then(data => { document.getElementById('location').value = data.display_name || ''; });
        }

        // ===== MAP RESIZE FIX =====
        // Ensures map fills container after Flexbox layout settles
        setTimeout(() => {
            map.invalidateSize();
        }, 200);

        // ===== FORM SUBMIT =====
        document.getElementById('issueForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formContainer = document.querySelector('.sidebar-form');
            const title = document.getElementById('title').value;
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            const lat = parseFloat(document.getElementById('lat').value);
            const lng = parseFloat(document.getElementById('lng').value);
            const userId = localStorage.getItem('user_id') || 1;

            if (!title || !category || !description || !lat || !lng) {
                // Visual shake/error effect
                formContainer.style.outline = '2px solid #dc2626';
                setTimeout(() => formContainer.style.outline = '', 1500);
                alert('Please fill all required fields and select a location.');
                return;
            }

            fetch('http://127.0.0.1:8000/api/issues/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, category, description, latitude: lat, longitude: lng, user_id: userId })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert("Report Submitted Successfully!");
                        this.reset();
                        if (marker) map.removeLayer(marker);
                        if (window.showToast) showToast("Issue Reported", "success");
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Submit failed. Check console.');
                });
        });

        // ===== ACCOUNT ACTIONS =====
        const accountLogo = document.getElementById('accountLogo');
        const accountDropdown = document.getElementById('accountDropdown');

        if (accountLogo && accountDropdown) {
            accountLogo.onclick = e => {
                accountDropdown.classList.toggle('show');
                e.stopPropagation();
            };
            document.getElementById('logoutBtn').onclick = () => { window.location.href = 'login.html'; };

            document.addEventListener('click', e => {
                if (!accountLogo.contains(e.target) && !accountDropdown.contains(e.target))
                    accountDropdown.classList.remove('show');
            });
        }

        // ===== PROFILE MODAL =====
        function showProfile() {
            const uid = localStorage.getItem('user_id') || 'Guest';
            const profileIdEl = document.getElementById('profileUserId');
            if (profileIdEl) profileIdEl.textContent = '#' + uid;

            document.getElementById('profileModal').classList.add('show');
            document.getElementById('accountDropdown').classList.remove('show'); // Close dropdown
        }

        function closeProfile() {
            document.getElementById('profileModal').classList.remove('show');
        }

        // Close modal on outside click
        document.getElementById('profileModal').addEventListener('click', function (e) {
            if (e.target === this) closeProfile();
        });
    </script>

</body>

</html>