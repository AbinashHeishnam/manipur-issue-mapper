<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manipur Issue Reporting Portal</title>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --gov-blue: #0b3c6f;
    --gov-gray: #f1f3f5;
    --text-dark: #212529;
    --border: #ced4da;
}

* { box-sizing: border-box; }
body { margin: 0; font-family: 'Inter', sans-serif; background: var(--gov-gray); color: var(--text-dark); }

/* ===== HEADER ===== */
header {
    background: white;
    border-bottom: 3px solid var(--gov-blue);
    padding: 16px 32px;
    position: relative;
}
header h1 { margin: 0; font-size: 1.8rem; color: var(--gov-blue); }
header p { margin: 4px 0 0; font-size: 0.95rem; color: #495057; }

#dashboardBtn {
    position: absolute; top: 18px; right: 80px;
    background: #1976d2; color: #fff; font-weight: 600;
    border: none; border-radius: 6px; padding: 8px 18px; cursor: pointer;
}

.account-logo {
    position: absolute; top: 18px; right: 32px;
    width: 40px; height: 40px; border-radius: 50%;
    background: #1976d2; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 8px #1976d288; cursor: pointer;
}

.account-logo img { width: 28px; height: 28px; border-radius: 50%; }

.account-dropdown {
    display: none; position: absolute; top: 60px; right: 32px;
    background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #1976d222;
    padding: 10px 16px; z-index: 100;
}

.account-dropdown button {
    background: #1976d2; color: #fff; font-weight: 600;
    border: none; border-radius: 6px; padding: 8px 18px; cursor: pointer;
}

/* ===== MAIN LAYOUT ===== */
main {
    max-width: 1300px;
    margin: 24px auto;
    padding: 0 24px;
    display: grid;
    grid-template-columns: 420px 1fr;
    gap: 24px;
}

/* ===== FORM CARD ===== */
.form-card {
    background: white; border-radius: 6px; border: 1px solid var(--border); padding: 20px;
}
.form-card h2 { margin: 0 0 12px; font-size: 1.2rem; color: var(--gov-blue); }

label { display: block; margin-top: 14px; font-weight: 600; font-size: 0.9rem; }

input, select, textarea {
    width: 100%; margin-top: 6px; padding: 8px 10px;
    border-radius: 4px; border: 1px solid var(--border); font-size: 0.9rem;
}

textarea { resize: vertical; min-height: 110px; }
input[readonly] { background: #e9ecef; cursor: not-allowed; }

/* ===== MAP ===== */
#map { height: 520px; background: white; border-radius: 6px; border: 1px solid var(--border); }

/* ===== FOOTER ===== */
footer { text-align: center; padding: 16px; font-size: 0.85rem; color: #6c757d; }

#viewLiveBtn {
    display:block; margin: 16px auto; background:#0b3c6f;color:#fff;padding:10px 20px;
    border:none;border-radius:6px;cursor:pointer; font-weight:600;
}
</style>
</head>

<body>

<header>
    <h1>Manipur Issue Reporting Portal</h1>
    <p>Official Government Citizen Interface</p>
    <div class="account-logo" id="accountLogo">
        <img src="https://api.dicebear.com/7.x/identicon/svg?seed=user" alt="Account">
    </div>
    <button id="dashboardBtn">Go to Dashboard</button>
    <div class="account-dropdown" id="accountDropdown">
        <button id="logoutBtn">Sign Out</button>
    </div>
</header>

<button id="viewLiveBtn">View Live</button>

<main>

    <!-- ISSUE FORM -->
    <section class="form-card">
        <h2>Report an Issue</h2>

        <form id="issueForm" autocomplete="off">

            <label>Issue Title</label>
            <input type="text" id="title" required>

            <label>Issue Category</label>
            <select id="category" required>
                <option value="">Select category</option>
                <option value="Road">Road & Transport</option>
                <option value="Water">Water Supply</option>
                <option value="Electricity">Electricity</option>
                <option value="Sanitation">Sanitation</option>
                <option value="Law">Law & Order</option>
            </select>

            <label>Selected Location</label>
            <div style="display:flex;gap:10px;align-items:center;">
                <input type="text" id="location" readonly placeholder="Click on map" required>
                <button type="button" id="detectLocationBtn">Detect My Location</button>
            </div>

            <label>Description</label>
            <textarea id="description" required></textarea>

            <label>Suggested Category (AI)</label>
            <input type="text" id="aiCategory" readonly placeholder="AI will suggest category">

            <!-- Hidden coordinates -->
            <input type="hidden" id="lat">
            <input type="hidden" id="lng">

            <!-- Submit button -->
            <button type="submit" style="margin-top: 16px;">Submit Issue</button>
        </form>
    </section>

    <!-- MAP -->
    <section id="map"></section>

</main>

<footer>
    © Government of Manipur • Secure Citizen Reporting System
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ===== VIEW LIVE =====
document.getElementById('viewLiveBtn').onclick = function() {
    window.location.href = 'live.html';
};

// ===== MAP INITIALIZATION =====
const map = L.map('map').setView([24.8170, 93.9368], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

let marker = null;

// ===== MAP CLICK EVENT =====
map.on('click', function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    if(marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map)
        .bindPopup('Selected location').openPopup();

    document.getElementById('lat').value = lat.toFixed(6);
    document.getElementById('lng').value = lng.toFixed(6);

    reverseGeocode(lat, lng);
});

// ===== GEOLOCATION BUTTON =====
document.getElementById('detectLocationBtn').onclick = function() {
    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            map.setView([lat, lng], 15);
            if(marker) map.removeLayer(marker);
            marker = L.marker([lat, lng]).addTo(map)
                .bindPopup('You are here').openPopup();

            document.getElementById('lat').value = lat.toFixed(6);
            document.getElementById('lng').value = lng.toFixed(6);
            reverseGeocode(lat, lng);
        }, function() { alert('Enable location to use this feature.'); });
    } else {
        alert('Geolocation not supported.');
    }
};

// ===== REVERSE GEOCODE =====
function reverseGeocode(lat, lng) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(res => res.json())
        .then(data => { document.getElementById('location').value = data.display_name || ''; });
}

// ===== FORM SUBMIT =====
document.getElementById('issueForm').addEventListener('submit', function(e){
    e.preventDefault();

    const formCard = document.querySelector('.form-card');
    const title = document.getElementById('title').value;
    const category = document.getElementById('category').value;
    const description = document.getElementById('description').value;
    const lat = parseFloat(document.getElementById('lat').value);
    const lng = parseFloat(document.getElementById('lng').value);
    const userId = window.currentUserId || 1;

    if(!title || !category || !description || !lat || !lng){
        formCard.style.border = '2px solid red';
        setTimeout(() => formCard.style.border = '1px solid #ced4da', 1500);
        alert('Please fill all required fields and select a location.');
        return;
    }

    fetch('http://127.0.0.1:8000/api/issues/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, category, description, latitude: lat, longitude: lng, user_id: userId })
    })
    .then(res => res.json())
    .then(data => {
        if(data.status==='success'){
            formCard.style.border = '2px solid green';
            setTimeout(() => formCard.style.border = '1px solid #ced4da', 1500);
            this.reset();
            if(marker) map.removeLayer(marker);
        } else {
            formCard.style.border = '2px solid red';
            setTimeout(() => formCard.style.border = '1px solid #ced4da', 1500);
            alert('Error: '+data.message);
        }
    })
    .catch(err => {
        formCard.style.border = '2px solid red';
        setTimeout(() => formCard.style.border = '1px solid #ced4da', 1500);
        console.error(err);
        alert('Submit failed. Check console.');
    });
});

// ===== DASHBOARD & ACCOUNT =====
document.getElementById('dashboardBtn').onclick = () => { window.location.href='dashboard.html'; };
const accountLogo = document.getElementById('accountLogo');
const accountDropdown = document.getElementById('accountDropdown');
accountLogo.onclick = e => { accountDropdown.style.display = accountDropdown.style.display==='block'?'none':'block'; e.stopPropagation(); };
document.getElementById('logoutBtn').onclick = () => { window.location.href='login.html'; };
document.addEventListener('click', e => { if(!accountLogo.contains(e.target) && !accountDropdown.contains(e.target)) accountDropdown.style.display='none'; });
</script>

</body>
</html>
