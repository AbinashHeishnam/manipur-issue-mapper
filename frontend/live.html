<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Issue Map - Manipur</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Heatmap Plugin -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
  body { margin:0; padding:0; font-family: 'Inter', sans-serif; }
  #map { width: 100%; height: 100vh; }
  .filter-btns {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  .filter-btns button {
      margin: 0 4px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      font-weight: 600;
  }
</style>
</head>

<body>

<div class="filter-btns">
    <button data-category="All">All</button>
    <button data-category="Road">Road</button>
    <button data-category="Water">Water</button>
    <button data-category="Electricity">Electricity</button>
    <button data-category="Sanitation">Sanitation</button>
    <button data-category="Law">Law & Order</button>
</div>

<div id="map"></div>

<script>
// ===== MAP INIT =====
const map = L.map('map').setView([24.8170, 93.9368], 10); // Manipur center

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

let heatLayer = null;
let allData = [];

// ===== FETCH ISSUES =====
async function loadIssues() {
    try {
        const res = await fetch('http://127.0.0.1:8000/api/issues/');
        const data = await res.json();
        if(data.status === 'success') {
            allData = data.data;
            updateHeatmap('All');
        } else {
            alert('Failed to fetch issues: ' + data.message);
        }
    } catch(err) {
        console.error('Fetch error:', err);
        alert('Could not load issues. Check server.');
    }
}

// ===== UPDATE HEATMAP =====
function updateHeatmap(category) {
    // Filter issues
    let filtered = allData;
    if(category !== 'All') {
        filtered = allData.filter(i => i.category === category);
    }

    // Prepare heat data: [lat, lng, intensity]
    const heatData = filtered.map(i => [
        i.latitude,
        i.longitude,
        i.severity || 1
    ]);

    // Remove existing heatLayer if exists
    if(heatLayer) map.removeLayer(heatLayer);

    // Add new heat layer
    heatLayer = L.heatLayer(heatData, {
        radius: 42,
        blur: 28,
        maxZoom: 17,
        gradient: {
            0.1: '#00ff00',    // bright green (light)
            0.4: '#ffff00',    // bright yellow (moderate)
            0.7: '#ffae00',    // orange-yellow (high)
            0.85: '#ff5500',   // orange-red (very high)
            1.0: '#ff0000'     // bright red (extreme)
        }
    }).addTo(map);
}

// ===== FILTER BUTTONS =====
document.querySelectorAll('.filter-btns button').forEach(btn => {
    btn.addEventListener('click', () => {
        const cat = btn.dataset.category;
        updateHeatmap(cat);
    });
});

// ===== INITIAL LOAD =====
loadIssues();
</script>

</body>
</html>
